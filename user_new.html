<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ì… ì‹ ì²­ - Sugar</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/common.js"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: #f8fafc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        #layout-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            width: 100%;
        }

        .signup-card {
            width: 100%;
            max-width: 500px;
            /* background, border, shadow removed */
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            background: linear-gradient(to right, #6366f1, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            height: 3rem;
            display: block;
        }

        /* Ensure password dots match placeholder height */
        input[type="password"] {
            font-family: 'Outfit', sans-serif;
        }

        .form-group input:focus {
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.08);
        }

        /* Fix for autofill white background */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0px 1000px #1e293b inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        .password-hint {
            font-size: 0.75rem;
            opacity: 0.5;
            margin-top: 0.3rem;
        }

        .consent-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 0.8rem;
            font-size: 0.8rem;
            height: 100px;
            overflow-y: auto;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.6);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .checkbox-group input {
            width: auto;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .submit-btn {
            flex: 2;
            height: 3rem;
            padding: 0 1rem;
            border-radius: 0.8rem;
            border: none;
            background: linear-gradient(to right, #6366f1, #a855f7);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cancel-btn {
            flex: 1;
            height: 3rem;
            padding: 0 1rem;
            border-radius: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .submit-btn:hover,
        .cancel-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:hover {
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);
        }

        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Select Styles */
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            box-sizing: border-box;
            outline: none;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            height: 3rem;
            display: block;
            appearance: none;
            cursor: pointer;
        }

        .form-group select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05) !important;
        }

        .form-group select:focus {
            border-color: #6366f1;
            background: rgba(255, 255, 255, 0.08);
        }

        .form-group select option {
            background: #1e293b;
            color: white;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1e293b;
            padding: 2.5rem 1rem;
            border-radius: 1.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .modal-text {
            font-size: 0.95rem;
            opacity: 0.8;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .modal-btns {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.7rem 1.5rem;
            border-radius: 0.6rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-confirm {
            background: #6366f1;
            color: white;
        }

        /* Wheel Picker Styles */
        .wheel-picker-container {
            display: flex;
            gap: 0.5rem;
            height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .wheel {
            flex: 1;
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
            padding: 40px 0;
            text-align: center;
        }

        .wheel::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari, Opera */
        }

        .wheel div {
            height: 40px;
            line-height: 40px;
            scroll-snap-align: center;
            font-size: 1rem;
            opacity: 0.3;
            transition: all 0.2s;
        }

        .wheel div.selected {
            opacity: 1;
            font-weight: 600;
            color: #6366f1;
            transform: scale(1.1);
        }

        .wheel-highlight {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 40px;
            transform: translateY(-50%);
            border-top: 1px solid rgba(99, 102, 241, 0.3);
            border-bottom: 1px solid rgba(99, 102, 241, 0.3);
            pointer-events: none;
            background: rgba(99, 102, 241, 0.05);
        }

        .error-msg {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 0.3rem;
            display: none;
        }

        .kakao-btn-container {
            margin-bottom: 2rem;
            text-align: center;
        }

        .kakao-btn {
            background: #FEE500;
            color: #000000;
            border: none;
            border-radius: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            height: 3rem;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.2s;
        }

        .kakao-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .kakao-hint {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 0.6rem;
        }

        input[readonly] {
            opacity: 0.7;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05) !important;
        }

        .wheel-picker-container.readonly {
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <main id="layout-main">
        <div class="signup-card">
            <h1 id="page-title">ê°€ì… ì‹ ì²­</h1>

            <div id="kakao-section" class="kakao-btn-container">
                <button onclick="loginWithKakao()" class="kakao-btn">
                    <img src="https://developers.kakao.com/assets/img/about/logos/kakaotalksharing/kakaotalk_sharing_btn_small.png"
                        width="24" height="24" alt="" />
                    ì¹´ì¹´ì˜¤ë¡œ ì¸ì¦
                </button>
                <p class="kakao-hint">ì¸ì¦ ì‹œ ì´ë¦„, ìƒë…„ì›”ì¼, ì—°ë½ì²˜ê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</p>
                <div id="test-mode-section"
                    style="display:none; margin-top: 1rem; border-top: 1px dashed rgba(255,255,255,0.1); padding-top: 1rem;">
                    <button onclick="generateRandomTenant()" class="cancel-btn"
                        style="width: 100%; flex: none; background: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.2); color: var(--accent);">
                        ğŸ² ì„¸ì…ì ëœë¤ ìƒì„± (TEST)
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label>ì•„ì´ë””(í•„ìˆ˜)</label>
                <input type="text" id="login_id" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸(í•„ìˆ˜)</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <div class="password-hint">ìˆ«ì, ì˜ë¬¸ ëŒ€ì†Œë¬¸ì í¬í•¨ 8~12ìë¦¬</div>
            </div>

            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="password_confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="form-group">
                <label>ì´ë¦„(í•„ìˆ˜)</label>
                <input type="text" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì¹´ì¹´ì˜¤ ì¸ì¦ ì‹œ ìë™ ì…ë ¥)" readonly>
            </div>

            <div class="form-group">
                <label>ìƒë…„ì›”ì¼(í•„ìˆ˜)</label>
                <input type="text" id="birth_date" placeholder="YYYY-MM-DD (ì¹´ì¹´ì˜¤ ì¸ì¦ ì‹œ ìë™ ì…ë ¥)" readonly>
            </div>

            <div class="form-group">
                <label>ì „í™”ë²ˆí˜¸(í•„ìˆ˜)</label>
                <input type="tel" id="phone_number" placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì¹´ì¹´ì˜¤ ì¸ì¦ ì‹œ ìë™ ì…ë ¥)" readonly>
            </div>

            <div class="form-group" id="building-group" style="display: none;">
                <label>ì„ëŒ€ ê±´ë¬¼ ì •ë³´</label>
                <select id="building_id" disabled onchange="handleBuildingChange()">
                    <option value="">ì¹´ì¹´ì˜¤ ì¸ì¦ í›„ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤</option>
                </select>
            </div>

            <div class="form-group" id="room-group" style="display: none;">
                <label>ë°© í˜¸ìˆ˜</label>
                <select id="room_number" disabled>
                    <option value="">ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>
                </select>
            </div>

            <div class="consent-box">
                [ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜]<br><br>
                1. ìˆ˜ì§‘í•­ëª©: ì´ë¦„(í•„ìˆ˜), ìƒì¼(í•„ìˆ˜), ì „í™”ë²ˆí˜¸(í•„ìˆ˜), ì•„ì´ë””(í•„ìˆ˜), ë¹„ë°€ë²ˆí˜¸(í•„ìˆ˜)<br>
                2. ì´ìš©ëª©ì : ì„œë¹„ìŠ¤ ì´ìš©ì ì‹ë³„ ë° ê³„ì•½ ê´€ë¦¬, ì•ŒëŒ ë°œì†¡<br>
                3. ë³´ìœ ê¸°ê°„: íšŒì› íƒˆí‡´ ì‹œ ì¦‰ì‹œ íŒŒê¸° (ë‹¨, ë²•ë ¹ì— ì˜ê±° ë³´ì¡´ í•„ìš” ì‹œ í•´ë‹¹ ê¸°ê°„ ë™ì•ˆ ë³´ê´€)<br>
                4. ë™ì˜ ê±°ë¶€ ì‹œ ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="consent">
                <label for="consent">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
            </div>

            <div class="btn-group">
                <button class="cancel-btn" onclick="location.href='/index.html'">ì·¨ì†Œ</button>
                <button class="submit-btn" onclick="handleSignUp()">ê°€ì… ì‹ ì²­</button>
            </div>
        </div>
    </main>

    <footer id="layout-footer">
        <div class="footer-container" style="flex-wrap: wrap;">
            <div class="footer-biz-name" onclick="toggleFooterInfo()">ìƒí˜¸ëª…: ê¹€ì§€ì„ , ê¹€ì„¸ë¯¸ ë¶€ë™ì‚°</div>
            <div class="footer-links">
                <a href="/terms.html" class="footer-btn" style="text-decoration: none;">ì´ìš©ì•½ê´€</a>
                <a href="/privacy.html" class="footer-btn" style="text-decoration: none;">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
            </div>
            <div id="footer-biz-details" class="footer-info-details">
                ìƒí˜¸ëª…: ê¹€ì§€ì„ , ê¹€ì„¸ë¯¸ ë¶€ë™ì‚°<br>
                ëŒ€í‘œìëª…: ê¹€ì§€ì„ ì™¸ 1ëª…<br>
                ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 640-31-00762<br>
                ì£¼ì†Œ: ê²½ê¸°ë„ ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬ ìš°ë§Œë™ 89-5 GSì§€ì—ìŠ¤íƒ€ì›Œ 403í˜¸
            </div>
        </div>
    </footer>

    <!-- Alert Modal -->
    <div id="alert-modal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
        <div class="modal-content">
            <div class="modal-title" id="alert-title">ì•Œë¦¼</div>
            <div class="modal-text" id="alert-text">ë©”ì‹œì§€ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            <div class="modal-btns">
                <button class="modal-btn btn-confirm" onclick="closeModal()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay" onclick="if(event.target === this) closeConfirmModal()">
        <div class="modal-content">
            <div class="modal-title">ê°€ì… ì‹ ì²­ í™•ì¸</div>
            <div class="modal-text">ê³„ì•½ì„œ í™•ì¸ ë° ì„ëŒ€ì¸ ìŠ¹ì¸ í›„ ê°€ì…ì´ ì™„ë£Œë©ë‹ˆë‹¤.<br>ì…ë ¥í•˜ì‹  ì •ë³´ë¡œ ê°€ì… ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeConfirmModal()">ë‹¤ì‹œ ìˆ˜ì •</button>
                <button class="modal-btn btn-confirm" onclick="submitSignUp()">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const role = urlParams.get('role') || 'tenant';

        document.getElementById('page-title').textContent = (role === 'landlord' ? 'ì„ëŒ€ì¸' : 'ì„¸ì…ì') + ' ê°€ì… ì‹ ì²­';

        if (role === 'tenant') {
            document.getElementById('building-group').style.display = 'block';
            document.getElementById('room-group').style.display = 'block';
        }

        async function loadBuildings() {
            try {
                const res = await fetch('/api/admin/buildings');
                const buildings = await res.json();
                const select = document.getElementById('building_id');
                select.innerHTML = '<option value="">ê±´ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>';
                buildings.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.textContent = b.name;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('Failed to load buildings:', err);
            }
        }

        async function handleBuildingChange() {
            const buildingId = document.getElementById('building_id').value;
            const roomSelect = document.getElementById('room_number');

            if (!buildingId) {
                roomSelect.innerHTML = '<option value="">ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”</option>';
                roomSelect.disabled = true;
                return;
            }

            try {
                const res = await fetch(`/api/buildings/${buildingId}/rooms`);
                const rooms = await res.json();
                roomSelect.innerHTML = '<option value="">í˜¸ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</option>';
                rooms.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id; // Store room_id
                    opt.textContent = r.room_number + 'í˜¸';
                    roomSelect.appendChild(opt);
                });
                roomSelect.disabled = false;
            } catch (err) {
                console.error('Failed to load rooms:', err);
                alert('ë°© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function initKakao() {
            let retries = 0;
            while (!window.Kakao && retries < 20) {
                await new Promise(r => setTimeout(r, 100));
                retries++;
            }

            if (!window.Kakao) return;

            try {
                const res = await fetch('/api/config/kakao');
                if (!res.ok) throw new Error('Failed to fetch config');
                const data = await res.json();

                if (data.kakaoKey) {
                    if (!Kakao.isInitialized()) {
                        Kakao.init(data.kakaoKey);
                    }
                }
            } catch (err) {
                console.error('Kakao Init Error:', err);
            }
        }
        initKakao();

        async function checkTestMode() {
            try {
                const res = await fetch('/api/config/mode');
                const data = await res.json();
                if (data.mode === 'TEST') {
                    document.getElementById('test-mode-section').style.display = 'block';
                }
            } catch (err) {
                console.error('Failed to check mode:', err);
            }
        }
        checkTestMode();

        function generateRandomTenant() {
            const lastNames = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ê°•', 'ì¡°', 'ìœ¤', 'ì¥', 'ì„', 'í•œ', 'ì˜¤', 'ì„œ', 'ì‹ ', 'ê¶Œ', 'í™©', 'ì•ˆ', 'ì†¡', 'ì „', 'í™'];
            const firstNames = ['ë¯¼ì¤€', 'ì„œì¤€', 'ë„ìœ¤', 'ì˜ˆì¤€', 'ì‹œìš°', 'í•˜ì¤€', 'ì£¼ì›', 'ì§€í˜¸', 'ì§€í›„', 'ì¤€ì„œ', 'ì„œìœ¤', 'ì„œì—°', 'ì§€ìš°', 'í•˜ìœ¤', 'í•˜ì€', 'ë¯¼ì„œ', 'ì§€ìœ ', 'ìœ¤ì„œ', 'ì§€ë¯¼', 'ì±„ì›'];

            const randomName = lastNames[Math.floor(Math.random() * lastNames.length)] + firstNames[Math.floor(Math.random() * firstNames.length)];

            // Random birth date (Age 20 ~ 50)
            const year = 2026 - (20 + Math.floor(Math.random() * 30));
            const month = String(1 + Math.floor(Math.random() * 12)).padStart(2, '0');
            const day = String(1 + Math.floor(Math.random() * 28)).padStart(2, '0');
            const randomBirth = `${year}-${month}-${day}`;

            // Random phone
            const p2 = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            const p3 = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
            const randomPhone = `010-${p2}-${p3}`;

            document.getElementById('name').value = randomName;
            document.getElementById('birth_date').value = randomBirth;
            document.getElementById('phone_number').value = randomPhone;
            document.getElementById('consent').checked = true;

            if (role === 'tenant') {
                loadBuildings();
                document.getElementById('building_id').disabled = false;
            }

            alert('ëœë¤ ì •ë³´ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        function loginWithKakao() {
            if (!window.Kakao || !Kakao.isInitialized()) {
                alert('ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            Kakao.Auth.login({
                success: function (authObj) {
                    Kakao.API.request({
                        url: '/v2/user/me',
                        success: function (res) {
                            const kakaoAccount = res.kakao_account;
                            console.log('Kakao Account Data:', kakaoAccount);
                            if (kakaoAccount) {
                                let updated = false;

                                // Name
                                const userName = kakaoAccount.name || (kakaoAccount.profile ? kakaoAccount.profile.nickname : '');
                                if (userName) {
                                    document.getElementById('name').value = userName;
                                    updated = true;
                                }

                                // Phone
                                if (kakaoAccount.phone_number) {
                                    let phoneValue = kakaoAccount.phone_number.replace('+82 ', '0').replace(/[^0-9]/g, '');
                                    if (phoneValue.startsWith('82')) {
                                        phoneValue = '0' + phoneValue.substring(2);
                                    }
                                    document.getElementById('phone_number').value = formatPhone(phoneValue);
                                    updated = true;
                                }

                                // Birth Date
                                if (kakaoAccount.birthyear && kakaoAccount.birthday) {
                                    const y = kakaoAccount.birthyear;
                                    const m = kakaoAccount.birthday.substring(0, 2);
                                    const d = kakaoAccount.birthday.substring(2, 4);
                                    document.getElementById('birth_date').value = `${y}-${m}-${d}`;
                                    updated = true;
                                } else if (kakaoAccount.birthyear) {
                                    document.getElementById('birth_date').value = kakaoAccount.birthyear;
                                    updated = true;
                                }

                                if (updated) {
                                    if (role === 'tenant') {
                                        loadBuildings();
                                        document.getElementById('building_id').disabled = false;
                                    }
                                    alert('ì¹´ì¹´ì˜¤ ì¸ì¦ ì„±ê³µ! ì •ë³´ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                                } else {
                                    alert('ì¹´ì¹´ì˜¤ ê³„ì •ì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                                }
                            }
                        },
                        fail: function (error) {
                            console.error(error);
                            alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });
                },
                fail: function (err) {
                    console.error(err);
                    alert('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        function showModal(title, text) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-text').textContent = text;
            document.getElementById('alert-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('alert-modal').style.display = 'none';
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
        }

        // Removed Wheel Picker logic as it's no longer used for birthdate

        document.getElementById('phone_number').addEventListener('input', (e) => {
            e.target.value = formatPhone(e.target.value);
        });

        function handleSignUp() {
            const login_id = document.getElementById('login_id').value.trim();
            const password = document.getElementById('password').value;
            const password_confirm = document.getElementById('password_confirm').value;
            const name = document.getElementById('name').value.trim();
            const birth_date = document.getElementById('birth_date').value;
            const phone_number = document.getElementById('phone_number').value.replace(/[^0-9]/g, '');
            const building_id = document.getElementById('building_id').value;
            const room_number = document.getElementById('room_number').value;
            const consent = document.getElementById('consent').checked;

            if (!login_id || !name || !birth_date || !phone_number) {
                showModal('ì…ë ¥ ì˜¤ë¥˜', 'ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (role === 'tenant' && (!building_id || !room_number)) {
                showModal('ì •ë³´ ì„ íƒ í•„ìš”', 'ì„ëŒ€ ê±´ë¬¼ê³¼ ë°© í˜¸ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // Password complexity: 8-12 chars, numbers, upper, lower
            const pwRegex = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,12}$/;
            if (!pwRegex.test(password)) {
                showModal('ë¹„ë°€ë²ˆí˜¸ ì¡°ê±´ ë¯¸ë‹¬', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì, ì˜ë¬¸ ëŒ€ì†Œë¬¸ìë¥¼ í¬í•¨í•˜ì—¬ 8~12ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            if (password !== password_confirm) {
                showModal('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜', 'ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            // Age check (18+)
            const bdate = new Date(birth_date);
            const today = new Date();
            let age = today.getFullYear() - bdate.getFullYear();
            const m = today.getMonth() - bdate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < bdate.getDate())) {
                age--;
            }
            if (age < 18) {
                showModal('ë¯¸ì„±ë…„ì ê°€ì… ì œí•œ', 'ë§Œ 18ì„¸ ë¯¸ë§Œì€ ê°€ì…ì´ ì œí•œë©ë‹ˆë‹¤.');
                return;
            }

            if (!consent) {
                showModal('ë™ì˜ í•„ìš”', 'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }

            // Show Confirm Modal instead of direct fetch
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        async function submitSignUp() {
            const login_id = document.getElementById('login_id').value.trim();
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value.trim();
            const birth_date = document.getElementById('birth_date').value;
            const phone_number = document.getElementById('phone_number').value.replace(/[^0-9]/g, '');
            const building_id = document.getElementById('building_id').value;
            const room_number = document.getElementById('room_number').value;

            try {
                const res = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        login_id, password, nickname: name, birth_date, phone_number, role, building_id, room_number
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/index.html';
                } else {
                    closeConfirmModal();
                    if (data.error === 'USER_EXISTS') {
                        showModal('ë™ì¼ì¸ ê°€ì… ë¶ˆê°€', 'ì—°ë½ì²˜ì™€ ìƒë…„ì›”ì¼ì´ ê°™ì€ ì‚¬ìš©ìê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.');
                    } else if (data.error === 'ID_EXISTS') {
                        showModal('ì¤‘ë³µ ì•„ì´ë””', 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.');
                    } else {
                        showModal('ì˜¤ë¥˜', data.error || 'ê°€ì… ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
            } catch (err) {
                closeConfirmModal();
                showModal('í†µì‹  ì˜¤ë¥˜', 'ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>

</html>