<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메시지함 - Sugar</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: #f8fafc;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.5rem;
            /* Reduced top/bottom padding */
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: 3.5rem;
            /* Fixed height to match other headers eventually */
        }

        .header h1 {
            font-size: 1.25rem;
            margin: 0;
            background: linear-gradient(to right, #6366f1, #a855f7);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container {
            padding: 0;
            width: 100%;
        }

        .notice-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .notice-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s;
            cursor: pointer;
        }

        .notice-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notice-summary {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            gap: 0.8rem;
            height: 4.5rem;
            /* Increased height to prevent clipping */
        }

        .notice-type {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 0.4rem;
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            white-space: nowrap;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            height: auto;
            max-height: 2rem;
        }

        .notice-type.signup {
            background: rgba(168, 85, 247, 0.2);
            color: #d8b4fe;
        }

        .notice-text-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            min-width: 0;
        }

        .notice-title {
            flex: 7;
            /* 7:3 ratio */
            font-size: 1rem;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: flex-end;
            padding-bottom: 2px;
        }

        .notice-meta {
            flex: 3;
            /* 7:3 ratio */
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding-top: 2px;
        }

        .status-btn-tmp {
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }

        .status-btn-approve {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .status-btn-reject {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .notice-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            align-self: center;
        }

        .action-btn {
            height: 2.2rem;
            /* Standardized for list layout */
            padding: 0 1rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 4rem;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>메시지함</h1>
        <button class="action-btn" onclick="location.href='/message_new.html'"
            style="background: rgba(99, 102, 241, 0.2); color: #a5b4fc; border: 1px solid rgba(99, 102, 241, 0.3);">메시지
            작성</button>
    </div>

    <div class="container">
        <div id="notice-list" class="notice-list">
            <!-- Items injected by JS -->
        </div>
    </div>



    <script src="/js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            renderNavbar();
            fetchNotices();
        });

        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) location.href = '/index.html';

        async function fetchNotices() {
            try {
                const res = await fetch(`/api/notices?role=${user.role}&user_id=${user.id}`);
                const notices = await res.json();
                renderNotices(notices);
            } catch (error) {
                console.error('Failed to fetch notices:', error);
            }
        }

        function renderNotices(notices) {
            const container = document.getElementById('notice-list');
            container.innerHTML = '';

            if (notices.length === 0) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5; padding:3rem;">메시지함이 비어있습니다.</div>';
                return;
            }

            notices.forEach(notice => {
                const item = document.createElement('div');
                item.className = 'notice-item';
                item.onclick = () => location.href = `/message_detail.html?id=${notice.id}`;

                const date = new Date(notice.created_at).toLocaleDateString();
                const isAuthor = (notice.author_id == user.id);

                let statusHtml = '';

                // Logic: Show status only for Author
                if (isAuthor) {
                    const total = notice.total_cnt || 0;
                    const read = notice.read_cnt || 0;
                    let text = '';
                    let cls = 'status-btn-tmp';

                    if (read === 0) {
                        text = '안읽음';
                        cls = 'status-btn-reject'; // Use reject style (Redish) for Unread, or tmp (Gray)
                    } else {
                        // Read > 0
                        cls = 'status-btn-approve'; // Green
                        if (total <= 1) {
                            text = '읽음';
                        } else {
                            text = `읽음(${read}/${total})`;
                        }
                    }
                    statusHtml = `<button class="action-btn ${cls}">${text}</button>`;
                } else {
                    // Recipient gets nothing
                    statusHtml = '';
                }

                // Delete Button
                statusHtml += `
                    <button class="action-btn status-btn-reject" onclick="deleteMessage(event, ${notice.id})">삭제</button>
                `;

                // Display category
                let displayCategory = notice.category || '알림';
                const isSignup = notice.category === '가입신청';
                if (displayCategory === '시스템') displayCategory = '메시지';

                item.innerHTML = `
                    <div class="notice-summary">
                        <div class="notice-actions-left" style="flex-shrink: 0; min-width: 4rem; display: flex; justify-content: center;">
                            <span class="notice-type ${isSignup ? 'signup' : ''}">${displayCategory}</span>
                        </div>
                        <div class="notice-text-group">
                            <span class="notice-title" title="${notice.title}">${notice.title}</span>
                            <div class="notice-meta">
                                <span>${date}</span>
                                <span>${notice.nickname || 'Unknown'}</span>
                            </div>
                        </div>
                        <div class="notice-actions" style="display: flex; align-items: center; gap: 0.2rem;">
                            ${statusHtml}
                        </div>
                    </div>`;

                container.appendChild(item);
            });
        }

        async function deleteMessage(event, id) {
            event.stopPropagation();
            if (!confirm('메시지를 삭제하시겠습니까?')) return;

            try {
                const res = await fetch(`/api/notices/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    fetchNotices(); // Refresh list
                } else {
                    const data = await res.json();
                    alert('삭제에 실패했습니다: ' + (data.error || '알 수 없는 오류'));
                }
            } catch (err) {
                console.error(err);
                alert('서버 오류');
            }
        }

        // Removed handleAction and toggleDetail as we now navigate to a detail page

        fetchNotices();
    </script>
</body>

</html>