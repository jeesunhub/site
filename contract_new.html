<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Form - Sugar</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body.in-iframe {
            background: transparent;
            padding: 0;
        }

        .form-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-section {
            background: transparent;
            border: none;
            padding: 0;
            margin-bottom: 0.5rem;
        }

        .form-section h2 {
            font-size: 1rem;
            margin-bottom: 0.12rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--primary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 0.12rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.02rem;
        }

        .form-group label {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 400;
            opacity: 1;
        }

        .form-group input,
        .form-group select {
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.8rem;
            border-radius: 0.8rem;
            color: #f8fafc;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group select {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
            padding-right: 2.5rem;
        }

        option {
            background-color: #1e293b;
            color: #f8fafc;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            outline: none;
            background: rgba(255, 255, 255, 0.08);
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-bar-right {
            display: flex;
            gap: 0.5rem;
        }

        .action-bar .btn {
            white-space: nowrap;
            padding: 0 1rem;
            /* Slightly reduced padding */
        }

        .field-label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.2rem;
        }

        .field-label-row label {
            margin-bottom: 0 !important;
        }

        .label-buttons {
            display: flex;
            gap: 0.6rem;
        }

        .btn-inline {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: opacity 0.2s;
            opacity: 0.8;
            line-height: 1;
        }

        .btn-inline:hover {
            opacity: 1;
            color: var(--primary);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.5rem;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 70px;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: 3.5rem;
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-size: 1.25rem;
            margin: 0;
            background: linear-gradient(to right, #6366f1, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Adjust container margin since we have a header now */
        .container {
            margin-top: 0 !important;
            padding-top: 0.5rem;
        }

        /* Debug Modal Styles */
        .debug-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .debug-modal-content {
            background: #1e293b;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            position: relative;
        }

        .debug-section {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .debug-section h3 {
            font-size: 1.1rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .debug-text-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
            color: #cbd5e1;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .debug-field-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .debug-field-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.8rem;
            border-radius: 0.5rem;
        }

        .debug-field-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 0.3rem;
        }

        .debug-field-value {
            font-size: 0.85rem;
            color: #f8fafc;
        }

        .close-debug-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>

</head>

<body id="page-body" class="has-back-button">
    <!-- Navbar will be rendered by JS -->
    <div class="header" id="sticky-header">
        <h1 id="page-title">ê³„ì•½ ë“±ë¡/ìˆ˜ì •</h1>
    </div>

    <div class="container" id="main-content">
        <div class="form-container">

            <div class="form-section">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.05); margin-bottom: 0.12rem; padding-bottom: 0.5rem;">
                    <h2 style="border:none; margin:0; padding:0;">ğŸ‘¤ ì„¸ì…ì ì •ë³´</h2>
                    <button type="button" id="btn-delete-tenant" class="btn-inline"
                        style="color: #ef4444; display: none;" onclick="deleteTenant()">ì„ì°¨ì¸ ì‚­ì œ</button>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label>ì„±ëª…</label><input type="text" id="tenant-name"
                            placeholder="ì„¸ì…ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" readonly
                            style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); cursor: not-allowed;">
                    </div>
                    <div class="form-group"><label>ìƒë…„ì›”ì¼</label><input type="date" id="tenant-dob" readonly
                            style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); cursor: not-allowed;">
                    </div>
                    <div class="form-group"><label>ì—°ë½ì²˜</label><input type="tel" id="tenant-phone"
                            placeholder="010-0000-0000" oninput="this.value = formatPhone(this.value)" readonly
                            style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); cursor: not-allowed;">
                    </div>
                </div>
            </div>
            <div class="form-section">
                <h2>ğŸ¢ ê±´ë¬¼ ë° í˜¸ìˆ˜</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ê±´ë¬¼ëª…</label>
                        <input type="text" id="contract-building-name" readonly
                            style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); cursor: not-allowed;">
                        <input type="hidden" id="contract-building">
                    </div>
                    <div class="form-group">
                        <label>í˜¸ìˆ˜ (ë°©ë²ˆí˜¸)</label>
                        <input type="text" id="contract-room-name" readonly
                            style="background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5); cursor: not-allowed;">
                        <input type="hidden" id="contract-room">
                    </div>
                </div>
            </div>
            <div class="form-section">
                <h2>ğŸ“„ ê³„ì•½ ì¡°ê±´</h2>
                <div class="form-grid">
                    <div class="form-group"><label>ê³„ì•½ ì‹œì‘ì¼</label><input type="date" id="contract-start"></div>
                    <div class="form-group">
                        <div class="field-label-row"><label>ê³„ì•½ ì¢…ë£Œì¼</label>
                            <div class="label-buttons">
                                <button type="button" class="btn-inline" onclick="addMonths(12)">+1ë…„</button>
                                <button type="button" class="btn-inline" onclick="addMonths(6)">+6ê°œì›”</button>
                            </div>
                        </div><input type="date" id="contract-end">
                    </div>
                    <div class="form-group"><label>ë‚©ë¶€ ë°©ì‹</label><select id="contract-payment-type">
                            <option value="prepaid">ì„ ë¶ˆ</option>
                            <option value="postpaid" selected>í›„ë¶ˆ</option>
                        </select></div>
                    <div class="form-group">
                        <div class="field-label-row"><label>ë³´ì¦ê¸ˆ (ì›)</label>
                            <div class="label-buttons">
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-deposit', 10000000)">+1ì²œë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-deposit', 1000000)">+1ë°±ë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-deposit', 100000)">+1ì‹­ë§Œ</button>
                            </div>
                        </div>
                        <input type="text" id="contract-deposit" value="0"
                            oninput="this.value = formatCurrency(this.value)">
                    </div>
                    <div class="form-group">
                        <div class="field-label-row"><label>ì›”ì„¸ (ì›)</label>
                            <div class="label-buttons">
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-rent', 100000)">+1ì‹­ë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-rent', 50000)">+5ë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-rent', 10000)">+1ë§Œ</button>
                            </div>
                        </div>
                        <input type="text" id="contract-rent" value="0"
                            oninput="this.value = formatCurrency(this.value)">
                    </div>
                    <div class="form-group">
                        <div class="field-label-row"><label>ê´€ë¦¬ë¹„ (ì›)</label>
                            <div class="label-buttons">
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-fee', 100000)">+1ì‹­ë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-fee', 50000)">+5ë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-fee', 10000)">+1ë§Œ</button>
                            </div>
                        </div>
                        <input type="text" id="contract-fee" value="0"
                            oninput="this.value = formatCurrency(this.value)">
                    </div>
                    <div class="form-group">
                        <div class="field-label-row"><label>ì²­ì†Œë¹„ (ì›)</label>
                            <div class="label-buttons">
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-cleaning', 100000)">+1ì‹­ë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-cleaning', 50000)">+5ë§Œ</button>
                                <button type="button" class="btn-inline"
                                    onclick="addAmount('contract-cleaning', 10000)">+1ë§Œ</button>
                            </div>
                        </div>
                        <input type="text" id="contract-cleaning" value="0"
                            oninput="this.value = formatCurrency(this.value)">
                    </div>
                </div>
            </div>
            <div class="action-bar">
                <button type="button" class="btn btn-secondary" onclick="showDebugModal()">Debug</button>
                <div class="action-bar-right" id="action-buttons">
                    <button class="btn btn-secondary" id="cancel-btn" onclick="handleCancel()">ì·¨ì†Œ</button>
                    <button class="btn" id="submit-btn" onclick="submitContract()">ì €ì¥</button>

                    <button class="btn btn-secondary" id="edit-btn" onclick="enableEditMode()"
                        style="display:none;">ìˆ˜ì •</button>
                    <button class="btn btn-secondary" id="extend-btn" onclick="enableExtendMode()"
                        style="display:none;">ì—°ì¥</button>
                    <button class="btn btn-reject" id="terminate-btn" onclick="openTerminateModal()"
                        style="display:none;">í‡´ì‹¤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Terminate Modal -->
    <div id="terminate-modal" class="modal" onclick="if(event.target === this) closeModal('terminate-modal')">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>ê³„ì•½ ì¢…ë£Œ ì„¤ì •</h2>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
                <label>í‡´ì‹¤ ì¼ì (ê³„ì•½ ì¢…ë£Œì¼)</label>
                <input type="date" id="termination-date" class="form-input">
            </div>
            <div class="modal-footer" style="margin-top: 2rem; display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('terminate-modal')" style="flex: 1;">ì·¨ì†Œ</button>
                <button class="btn" id="confirm-terminate-btn" style="flex: 1;">ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- Debug Modal -->
    <div id="debug-view-modal" class="debug-modal" onclick="if(event.target === this) closeDebugModal()">
        <div class="debug-modal-content">
            <button class="close-debug-btn" onclick="closeDebugModal()">Ã—</button>
            <h2 style="margin-bottom: 2rem;">ğŸ” ì¶”ì¶œ ë°ì´í„° ë¶„ì„</h2>

            <div class="debug-section">
                <h3>ì „ì²´ ì¶”ì¶œ í…ìŠ¤íŠ¸</h3>
                <div id="debug-full-text" class="debug-text-box"></div>
            </div>

            <div class="debug-section">
                <h3>í•„ë“œë³„ ì¶”ì¶œ ìƒì„¸</h3>
                <div id="debug-fields" class="debug-field-list">
                    <!-- Dynamic segments -->
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="closeDebugModal()" style="width: 200px;">í™•ì¸</button>
            </div>
        </div>
    </div>
    <script src="/js/common.js"></script>
    <script>const user = JSON.parse(localStorage.getItem('user'));
        const urlParams = new URLSearchParams(window.location.search);
        let currentAction = urlParams.get('action');
        const contractId = urlParams.get('contract_id');
        const isIframe = window.self !== window.top;
        let currentTenantId = null;

        if (!user) {
            window.location.href = '/index.html';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (isIframe) {
                document.getElementById('page-body').classList.add('in-iframe');
                const header = document.getElementById('sticky-header');
                if (header) header.style.display = 'none';
                // Navbar is handled by common.js, but we can prevent it or it will just be hidden if we don't call it.
            }

            else {
                renderNavbar();
            }

            await loadBuildings();

            // Pre-fill from URL params (e.g. from Text Extraction or Tenant Mgmt)
            const urlBuildingName = urlParams.get('building_name');
            const urlBuildingId = urlParams.get('building_id');
            const urlRoomNumber = urlParams.get('room_number');
            const urlRoomId = urlParams.get('room_id');

            if (urlBuildingId) {
                const bIdInput = document.getElementById('contract-building');
                const bNameInput = document.getElementById('contract-building-name');
                bIdInput.value = urlBuildingId;

                // Fetch buildings to find the name
                const apiPath = user.role === 'admin' ? '/api/admin/buildings' : `/api/landlord/${user.id}/buildings`;
                const bRes = await fetch(apiPath);
                const buildings = await bRes.json();
                const matched = buildings.find(b => String(b.id) === String(urlBuildingId));
                if (matched) {
                    bNameInput.value = matched.name;
                    await loadRooms(urlRoomId || urlRoomNumber);
                }
            } else if (urlBuildingName) {
                const bIdInput = document.getElementById('contract-building');
                const bNameInput = document.getElementById('contract-building-name');
                bNameInput.value = urlBuildingName;

                const apiPath = user.role === 'admin' ? '/api/admin/buildings' : `/api/landlord/${user.id}/buildings`;
                const bRes = await fetch(apiPath);
                const buildings = await bRes.json();
                const matched = buildings.find(b => b.name === urlBuildingName);
                if (matched) {
                    bIdInput.value = matched.id;
                    await loadRooms(urlRoomId || urlRoomNumber);
                }
            } else if (urlParams.get('tenant_name') && urlParams.get('tenant_dob')) {
                const name = urlParams.get('tenant_name');
                const dob = urlParams.get('tenant_dob');

                try {
                    const res = await fetch('/api/users/find', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, birth_date: dob, role: 'tenant' })
                    });
                    const users = await res.json();
                    if (users.length > 0 && users[0].building_id) {
                        const user = users[0];
                        currentTenantId = user.id;
                        document.getElementById('btn-delete-tenant').style.display = 'block';

                        const bIdInput = document.getElementById('contract-building');
                        const bNameInput = document.getElementById('contract-building-name');

                        bIdInput.value = user.building_id;
                        bNameInput.value = user.building_name || '';

                        await loadRooms(user.room_id || user.room_number);
                    }
                } catch (e) {
                    console.error('Error auto-filling room from tenant:', e);
                }
            }
            if (urlParams.get('deposit')) document.getElementById('contract-deposit').value = formatCurrency(urlParams.get('deposit'));
            if (urlParams.get('rent')) document.getElementById('contract-rent').value = formatCurrency(urlParams.get('rent'));
            if (urlParams.get('rent_type')) document.getElementById('contract-payment-type').value = urlParams.get('rent_type');
            if (urlParams.get('mgmt_fee')) document.getElementById('contract-fee').value = formatCurrency(urlParams.get('mgmt_fee'));
            if (urlParams.get('cleaning_fee')) document.getElementById('contract-cleaning').value = formatCurrency(urlParams.get('cleaning_fee'));
            if (urlParams.get('start_date')) document.getElementById('contract-start').value = urlParams.get('start_date');
            if (urlParams.get('end_date')) document.getElementById('contract-end').value = urlParams.get('end_date');
            if (urlParams.get('tenant_name')) document.getElementById('tenant-name').value = urlParams.get('tenant_name');
            if (urlParams.get('tenant_phone')) document.getElementById('tenant-phone').value = formatPhone(urlParams.get('tenant_phone'));
            if (urlParams.get('tenant_dob')) document.getElementById('tenant-dob').value = urlParams.get('tenant_dob');

            if (contractId) {
                await loadContractData(contractId);
            }

            if (currentAction === 'extend') {
                document.getElementById('page-title').textContent = 'ê³„ì•½ ì—°ì¥';
            }

            else if (currentAction === 'change') {
                document.getElementById('page-title').textContent = 'ê³„ì•½ ë³€ê²½';
            }

            else if (currentAction === 'view') {
                document.getElementById('page-title').textContent = 'ê³„ì•½ ì •ë³´ í™•ì¸';
                disableForm();
            }
        });

        function disableForm() {
            // Disable all inputs and selects
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(el => el.disabled = true);

            // Hide action buttons and date helpers
            document.getElementById('submit-btn').style.display = 'none';
            document.querySelectorAll('.btn-inline').forEach(el => el.style.display = 'none');

            // Hide cancel button in view mode as top navbar has one
            document.getElementById('cancel-btn').style.display = 'none';

            // Show view actions (Edit, Extend, Terminate)
            document.getElementById('edit-btn').style.display = 'block';
            document.getElementById('extend-btn').style.display = 'block';
            document.getElementById('terminate-btn').style.display = 'block';
        }

        function enableEditMode() {
            // Re-enable all inputs (except readonly/pre-filled ones)
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(el => {
                if (el.id === 'contract-room' && el.value) return; // Keep pre-filled room disabled if wanted
                if (['tenant-name', 'tenant-dob', 'tenant-phone', 'contract-building-name', 'contract-room-name'].includes(el.id)) return;
                el.disabled = false;
            });

            // Toggle buttons
            document.getElementById('submit-btn').style.display = 'block';
            document.getElementById('cancel-btn').style.display = 'block';
            document.getElementById('cancel-btn').textContent = 'ì·¨ì†Œ';

            // Hide view actions
            document.getElementById('edit-btn').style.display = 'none';
            document.getElementById('extend-btn').style.display = 'none';
            document.getElementById('terminate-btn').style.display = 'none';

            document.querySelectorAll('.btn-inline').forEach(el => el.style.display = 'block');

            // Change title
            document.getElementById('page-title').textContent = 'ê³„ì•½ ìˆ˜ì •';
            currentAction = 'change';
            window.history.replaceState({}, '', `/contract_new.html?action=change&contract_id=${contractId}`);
        }

        function enableExtendMode() {
            const startInput = document.getElementById('contract-start');
            const endInput = document.getElementById('contract-end');

            if (startInput.value && endInput.value) {
                const oldStart = new Date(startInput.value);
                const oldEnd = new Date(endInput.value);

                // Calculate duration in days (including both start and end dates usually)
                // However, simple difference in time is most robust for "same period"
                const durationMs = oldEnd.getTime() - oldStart.getTime();

                // New Start = Old End + 1 day
                const newStart = new Date(oldEnd);
                newStart.setDate(newStart.getDate() + 1);

                // New End = New Start + duration
                const newEnd = new Date(newStart.getTime() + durationMs);

                const formatDate = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };

                startInput.value = formatDate(newStart);
                endInput.value = formatDate(newEnd);
            }

            enableEditMode();
            document.getElementById('page-title').textContent = 'ê³„ì•½ ì—°ì¥';
            currentAction = 'extend';
            window.history.replaceState({}, '', `/contract_new.html?action=extend&contract_id=${contractId}`);
        }

        function openTerminateModal() {
            document.getElementById('termination-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('terminate-modal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        document.getElementById('confirm-terminate-btn').onclick = async () => {
            const endDate = document.getElementById('termination-date').value;
            if (!endDate) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');

            try {
                const res = await fetch(`/api/contracts/${contractId}/terminate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ end_date: endDate })
                });
                if (res.ok) {
                    alert('ê³„ì•½ ì¢…ë£Œ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.href = '/tenants.html';
                }
            } catch (err) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        async function loadBuildings() {
            // No longer populating a select, but we can use this to resolve the name if missing
            if (currentAction === 'new' && !urlParams.get('building_id') && !urlParams.get('building_name')) {
                const apiPath = user.role === 'admin' ? '/api/admin/buildings' : `/api/landlord/${user.id}/buildings`;
                const res = await fetch(apiPath);
                const buildings = await res.json();
                if (buildings.length > 0) {
                    document.getElementById('contract-building').value = buildings[0].id;
                    document.getElementById('contract-building-name').value = buildings[0].name;
                    await loadRooms();
                }
            }
        }

        async function loadRooms(selectedRoomIdentifier = null) {
            const buildingId = document.getElementById('contract-building').value;
            const roomNameInput = document.getElementById('contract-room-name');
            const roomIdInput = document.getElementById('contract-room');

            if (!buildingId) {
                roomNameInput.value = 'ê±´ë¬¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”';
                return;
            }

            const res = await fetch(`/api/buildings/${buildingId}/rooms`);
            const rooms = await res.json();

            let matchedRoom = null;
            if (selectedRoomIdentifier) {
                matchedRoom = rooms.find(r => r.id == selectedRoomIdentifier || r.room_number == selectedRoomIdentifier);
            } else if (rooms.length > 0) {
                matchedRoom = rooms[0];
            }

            if (matchedRoom) {
                roomIdInput.value = matchedRoom.id;
                roomNameInput.value = matchedRoom.room_number + 'í˜¸';
            } else {
                roomNameInput.value = 'í˜¸ìˆ˜ ì •ë³´ ì—†ìŒ';
            }
        }

        async function loadContractData(id) {
            const res = await fetch(`/api/contract/${id}/full-details`);
            const data = await res.json();
            const c = data.contract;
            currentTenantId = c.tenant_id;
            if (currentTenantId) document.getElementById('btn-delete-tenant').style.display = 'block';

            document.getElementById('tenant-name').value = c.tenant_name;
            document.getElementById('tenant-dob').value = c.birth_date;
            document.getElementById('tenant-phone').value = formatPhone(c.phone_number);
            document.getElementById('tenant-phone').value = formatPhone(c.phone_number);
            document.getElementById('contract-building').value = c.building_id;
            document.getElementById('contract-building-name').value = c.building;
            await loadRooms(c.room_number);
            document.getElementById('contract-start').value = c.contract_start_date;
            document.getElementById('contract-end').value = c.contract_end_date;
            document.getElementById('contract-payment-type').value = c.payment_type;
            document.getElementById('contract-deposit').value = formatCurrency(c.deposit);
            document.getElementById('contract-rent').value = formatCurrency(c.monthly_rent);
            document.getElementById('contract-fee').value = formatCurrency(c.maintenance_fee);
            document.getElementById('contract-cleaning').value = formatCurrency(c.cleaning_fee || 0);
        }

        function addMonths(months) {
            const startInput = document.getElementById('contract-start');
            const endInput = document.getElementById('contract-end');

            if (!startInput.value) {
                alert('ê³„ì•½ ì‹œì‘ì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            let d;

            if (endInput.value) {
                // Increment from current end date
                d = new Date(endInput.value);
                d.setMonth(d.getMonth() + months);
            }

            else {
                // Initial: Start date + offset months - 1 day
                d = new Date(startInput.value);
                d.setMonth(d.getMonth() + months);
                d.setDate(d.getDate() - 1);
            }

            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dVal = String(d.getDate()).padStart(2, '0');

            endInput.value = `${y}-${m}-${dVal}`;
        }

        function addAmount(id, amount) {
            const el = document.getElementById(id);
            if (!el) return;
            const currentVal = unformatCurrency(el.value || '0');
            el.value = formatCurrency(currentVal + amount);
        }

        function handleCancel() {
            if (isIframe) {
                window.parent.postMessage('close_modal', '*');
            }

            else {
                window.history.back();
            }
        }

        async function submitContract() {
            const data = {
                landlord_id: user.id,
                tenant_name: document.getElementById('tenant-name').value,
                tenant_dob: document.getElementById('tenant-dob').value,
                tenant_phone: document.getElementById('tenant-phone').value,
                building_id: document.getElementById('contract-building').value,
                room_id: document.getElementById('contract-room').value,
                start_date: document.getElementById('contract-start').value,
                end_date: document.getElementById('contract-end').value,
                deposit: unformatCurrency(document.getElementById('contract-deposit').value),
                monthly_rent: unformatCurrency(document.getElementById('contract-rent').value),
                management_fee: unformatCurrency(document.getElementById('contract-fee').value),
                cleaning_fee: unformatCurrency(document.getElementById('contract-cleaning').value),
                payment_type: document.getElementById('contract-payment-type').value
            };

            if (!data.tenant_name || !data.building_id || !data.room_id) {
                alert('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // Check if user exists first to avoid UNIQUE constraint violation on login_id
                const existingUserId = await fetchUserId(data.tenant_name, data.tenant_dob);
                let targetUserId = existingUserId;

                if (!targetUserId && currentAction === 'change') {
                    // If no existing user found matches the new details, but we are in change mode,
                    // we update the CURRENT tenant (correcting their info).
                    // This implies the new Name/DOB slot is free (since fetch returned null).
                    targetUserId = currentTenantId;
                }

                // If !targetUserId and action !== 'change', we send null (Create New)

                // ALWAYS Save/Update Tenant first
                const userSavePayload = {
                    id: targetUserId,
                    password: '1234',
                    nickname: data.tenant_name,
                    role: 'tenant',
                    birth_date: data.tenant_dob,
                    phone_number: data.tenant_phone,
                    building_id: data.building_id,
                    status: 'ìŠ¹ì¸',
                    approved: 1
                };

                // Only generate login_id for NEW users
                if (!targetUserId && !userSavePayload.login_id) {
                    userSavePayload.login_id = data.tenant_name + data.tenant_dob.replace(/-/g, '').slice(2);
                }

                ;

                const userRes = await fetch('/api/users/quick', {

                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify(userSavePayload)
                });
                const userData = await userRes.json();

                if (!userRes.ok) {
                    throw new Error(userData.error || 'ì„¸ì…ì ì •ë³´ ì €ì¥ ì‹¤íŒ¨');
                }

                data.tenant_id = userData.userId;

                let url = '/api/contracts/full';
                let method = 'POST';

                let payload = {
                    tenant_id: data.tenant_id,
                    landlord_id: data.landlord_id,
                    payment_type: data.payment_type,
                    contract_start_date: data.start_date,
                    contract_end_date: data.end_date,
                    deposit: data.deposit,
                    monthly_rent: data.monthly_rent,
                    management_fee: data.management_fee,
                    cleaning_fee: data.cleaning_fee,
                    room_id: data.room_id
                };

                if ((currentAction === 'change' || currentAction === 'extend') && contractId) {
                    url = `/api/contracts/${contractId}`;
                    method = 'PUT';
                    payload.keyword = data.tenant_name; // Maintain keyword on update
                }

                const contractRes = await fetch(url, {

                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify(payload)
                });

                if (contractRes.ok) {
                    if (isIframe) {
                        window.parent.postMessage('contract_saved', '*');
                    }

                    else {
                        window.location.href = '/tenants.html';
                    }
                }

                else {
                    const errData = await contractRes.json();
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (errData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            }

            catch (err) {
                console.error(err);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function fetchUserId(name, dob) {
            const res = await fetch('/api/users/find', {

                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }

                ,
                body: JSON.stringify({
                    name, birth_date: dob, role: 'tenant'
                })
            });
            const users = await res.json();
            return users[0]?.id;
        }

        function showDebugModal() {
            const parsedDataJson = sessionStorage.getItem('lastFullParsedData');
            const fullText = sessionStorage.getItem('lastExtractedText');

            if (!parsedDataJson) {
                alert('ìµœê·¼ ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const parsedData = JSON.parse(parsedDataJson);

            // Show full text from separate key
            document.getElementById('debug-full-text').textContent = fullText || "ì¶”ì¶œëœ ì „ì²´ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";

            const fieldsContainer = document.getElementById('debug-fields');
            fieldsContainer.innerHTML = '';

            const fieldMapping = [
                { key: 'tenantName', raw: 'tenantName', label: 'ì„¸ì…ì ì„±ëª…', criteria: 'í‚¤ì›Œë“œ: ì„±ëª…', format: v => v },
                { key: 'tenantDob', raw: 'tenantDob', label: 'ìƒë…„ì›”ì¼', criteria: 'í‚¤ì›Œë“œ: ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ìƒë…„ì›”ì¼', format: v => v },
                { key: 'tenantPhone', raw: 'tenantPhone', label: 'ì—°ë½ì²˜', criteria: 'í‚¤ì›Œë“œ: ì „í™”, ì—°ë½ì²˜', format: v => formatPhone(v) },
                { key: 'address', raw: 'address', label: 'ì£¼ì†Œ', criteria: 'í‚¤ì›Œë“œ: ì†Œ ì¬ ì§€ ~ í† ì§€/ê±´ë¬¼', format: v => v },
                { key: 'roomNumber', raw: 'room', label: 'í˜¸ìˆ˜', criteria: 'í‚¤ì›Œë“œ: ì„ëŒ€ë¶€ë¶„', format: v => v + 'í˜¸' },
                { key: 'deposit', raw: 'deposit', label: 'ë³´ì¦ê¸ˆ', criteria: 'í‚¤ì›Œë“œ: ë³´ì¦ê¸ˆ ~ ê¸ˆ...ì›', format: v => formatCurrency(v) + 'ì›' },
                { key: 'rent', raw: 'rent', label: 'ì›”ì„¸', criteria: 'í‚¤ì›Œë“œ: ì°¨ì„ ~ ì œ 2 ì¡°', format: v => formatCurrency(v) + 'ì›' },
                { key: 'managementFee', raw: 'mgmtFee', label: 'ê´€ë¦¬ë¹„', criteria: 'í‚¤ì›Œë“œ: ê´€ë¦¬ë¹„ëŠ”', format: v => formatCurrency(v) + 'ì›' },
                { key: 'cleaningFee', raw: 'cleanFee', label: 'ì²­ì†Œë¹„', criteria: 'í‚¤ì›Œë“œ: ì²­ì†Œë¹„', format: v => formatCurrency(v) + 'ì›' },
                { key: 'startDate', raw: 'startDate', label: 'ì‹œì‘ì¼', criteria: 'í‚¤ì›Œë“œ: ì œ 2 ì¡°', format: v => v },
                { key: 'endDate', raw: 'endDate', label: 'ì¢…ë£Œì¼', criteria: 'í‚¤ì›Œë“œ: ì¸ë„ì¼ë¡œë¶€í„°', format: v => v }
            ];

            fieldMapping.forEach(item => {
                const value = parsedData[item.key];
                const rawSentence = parsedData.raw[item.raw];

                const div = document.createElement('div');
                div.className = 'debug-field-item';
                div.style.gridColumn = 'span 2';
                div.style.backgroundColor = 'rgba(255,255,255,0.02)';
                div.style.border = '1px solid rgba(255,255,255,0.05)';
                div.style.marginBottom = '0.5rem';

                let extraHtml = '';
                if (item.key === 'tenantName' && parsedData.nameKeywords && parsedData.nameKeywords.length > 0) {
                    extraHtml = `
                        <div class="debug-field-label" style="color: #fbbf24; font-weight: 600; margin-top: 0.8rem; margin-bottom: 0.2rem;">ğŸ” ë°œê²¬ëœ ì„±ëª… í‚¤ì›Œë“œ ëª©ë¡:</div>
                        <div style="font-size: 0.75rem; color: #d1d5db; margin-bottom: 0.6rem; padding-left: 0.5rem; background: rgba(251, 191, 36, 0.05); border-radius: 4px;">
                            ${parsedData.nameKeywords.map(kw => `<div style="margin-bottom:2px;">â€¢ ...${kw}...</div>`).join('')}
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.9rem; font-weight: 600; color: var(--primary);">${item.label}</span>
                        <span style="font-size: 1rem; font-weight: 600; color: #fff;">${item.format(value) || '-'}</span>
                    </div>
                    <div class="debug-field-label" style="color: var(--accent); font-weight: 600; margin-bottom: 0.2rem;">âš™ï¸ ì¶”ì¶œ ì¡°ê±´:</div>
                    <div style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 0.6rem; padding-left: 0.5rem;">${item.criteria}</div>
                    
                    ${extraHtml}

                    <div class="debug-field-label">ğŸ“„ ì¶”ì¶œ ê·¼ê±° ë¬¸ì¥:</div>
                    <div class="debug-field-value" style="background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.4rem; color: #a5b4fc; font-style: italic;">
                        "${rawSentence || 'ë§¤ì¹­ëœ ë¬¸ì¥ ì—†ìŒ'}"
                    </div>
                `;
                fieldsContainer.appendChild(div);
            });

            document.getElementById('debug-view-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeDebugModal() {
            document.getElementById('debug-view-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        async function deleteTenant() {
            if (!currentTenantId) return;
            if (!confirm('ì •ë§ë¡œ ì´ ì„¸ì…ìë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°(ê³„ì•½, ë©”ì‹œì§€ ë“±)ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;

            try {
                const res = await fetch(`/api/users/${currentTenantId}?hard=true`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) {
                    alert('ì„¸ì…ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    if (isIframe) {
                        window.parent.postMessage('reload_tenants', '*');
                    }
                    window.location.reload();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

    </script>
</body>

</html>