<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenants - Sugar</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        .tenant-mgmt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.5rem;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 70px;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: 3.5rem;
            width: 100%;
            box-sizing: border-box;
            /* Important for padding */
        }

        .tenant-mgmt-header h1 {
            font-size: 1.25rem !important;
            /* Force override inline style if any */
            margin: 0;
            background: linear-gradient(to right, #6366f1, #a855f7);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
            margin-right: 1rem;
        }

        .container {
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .building-block {
            margin-bottom: 2rem;
            width: 100%;
        }

        .building-name-header {
            padding: 1.2rem 1.5rem 0.6rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.05rem;
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.01);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .tenant-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tenant-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s;
        }

        .tenant-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tenant-summary {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            gap: 1.2rem;
            min-height: 5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            transition: background 0.2s;
        }

        .tenant-summary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .room-badge {
            width: 4.5rem;
            padding: 0.4rem 0.2rem;
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
            border-radius: 0.4rem;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1px;
            min-height: 3.2rem;
        }

        .room-badge .b-name {
            font-size: 0.65rem;
            opacity: 0.7;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 400;
        }

        .room-badge .r-num {
            font-size: 0.9rem;
            font-weight: 700;
            width: 100%;
        }

        .tenant-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            min-width: 0;
        }

        .center-top {
            flex: 1;
            display: flex;
            align-items: flex-end;
            font-size: 1rem;
            font-weight: 400;
            padding-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #f8fafc;
        }

        .center-bottom {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
            gap: 0px;
            padding-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tenant-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            align-self: center;
        }

        .action-btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-edit {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .btn-edit:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .btn-del {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-del:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .full-modal {
            width: 95%;
            max-width: 1000px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .simple-modal {
            max-width: 400px;
        }

        /* Iframe styling no longer needed */
        .list-controls {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.8rem;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .control-btn.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--accent);
        }
    </style>
</head>

<body class="has-back-button">
    <!-- Navbar will be rendered by JS -->

    <div class="tenant-mgmt-header">
        <h1>ì„¸ì…ì ê´€ë¦¬</h1>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="file" id="ai-file-input" accept=".pdf, .png, .jpg, .jpeg" style="display: none;"
                onchange="handleFileSelect(event)">
            <button class="btn btn-secondary" style="height: auto; padding: 0.4rem 0.8rem; font-size: 0.8rem;"
                onclick="startAIUpload()">íŒŒì¼ ì—…ë¡œë“œ</button>
            <button class="btn" style="height: auto; padding: 0.4rem 0.8rem; font-size: 0.8rem;"
                onclick="navigateToContractForm('new')">ì§ì ‘ ì¶”ê°€</button>
        </div>
    </div>

    <div class="container" id="main-content">
        <div class="list-controls">
            <button id="toggle-terminated-btn" class="control-btn" onclick="toggleTerminatedVisibility()">
                <span id="terminated-btn-text">ê³„ì•½ ì¢…ë£Œ ìˆ¨ê¹€</span>
            </button>
            <button id="sort-method-btn" class="control-btn" onclick="toggleSortMethod()">
                <span>ì •ë ¬: </span>
                <span id="sort-btn-text">ê±´ë¬¼ í˜¸ìˆ˜ë³„</span>
            </button>
        </div>

        <div id="tenant-blocks-container">
            <!-- Content will be populated by JS -->
        </div>
    </div>

    <!-- Debug Modal -->
    <div id="debug-modal" class="modal" onclick="if(event.target === this) closeModal('debug-modal')">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>ì¶”ì¶œëœ í…ìŠ¤íŠ¸ ë‚´ìš© (Debug)</h2>
            </div>
            <div id="ocr-debug-content"
                style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 1rem; max-height: 250px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; font-size: 0.85rem; margin-bottom: 1rem; color: #e2e8f0; border: 1px solid rgba(255,255,255,0.1);">
                ì¶”ì¶œëœ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
            </div>
            <div id="parsed-result-view"
                style="background: rgba(99, 102, 241, 0.1); padding: 1.5rem; border-radius: 1rem; border: 1px solid rgba(99, 102, 241, 0.2); margin-bottom: 1.5rem;">
                <h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--accent);">ğŸ“Š ì¶”ì¶œ ë°ì´í„° ìš”ì•½</h3>
                <div id="parsed-summary"
                    style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.9rem;">
                    <!-- Parsed items will go here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('debug-modal')">ë‹«ê¸°</button>
                <button class="btn" id="proceed-create-btn" onclick="proceedWithParsedData()" style="display: none;">ìë™
                    ì…ë ¥ & ê³„ì•½ ë“±ë¡ ì‹œì‘</button>
            </div>
        </div>
    </div>
    <div id="terminate-modal" class="modal" onclick="if(event.target === this) closeModal('terminate-modal')">
        <div class="modal-content simple-modal">
            <div class="modal-header">
                <h2>ê³„ì•½ ì¢…ë£Œ ì„¤ì •</h2>
            </div>
            <div class="form-group">
                <p id="terminate-target-name" style="margin-bottom: 1rem; opacity: 0.8;"></p>
                <label>í‡´ì‹¤ ì¼ì (ê³„ì•½ ì¢…ë£Œì¼)</label>
                <input type="date" id="termination-date" class="form-input">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('terminate-modal')">ì·¨ì†Œ</button>
                <button class="btn" id="confirm-terminate-btn">ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- Full Form Modal removed -->

    <script src="/js/common.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user'));
        let hideTerminated = false;
        let sortMethod = 'room'; // 'room' or 'expiration'
        let allTenants = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!user) {
                window.location.href = '/index.html';
                return;
            }
            renderNavbar();
            await loadAndRenderTenants();
        });

        function toggleTerminatedVisibility() {
            hideTerminated = !hideTerminated;
            const btnText = document.getElementById('terminated-btn-text');
            const btn = document.getElementById('toggle-terminated-btn');

            if (hideTerminated) {
                btnText.textContent = 'ê³„ì•½ ì¢…ë£Œ ë³´ì„';
                btn.classList.add('active');
            } else {
                btnText.textContent = 'ê³„ì•½ ì¢…ë£Œ ìˆ¨ê¹€';
                btn.classList.remove('active');
            }
            renderTenants();
        }

        function toggleSortMethod() {
            sortMethod = sortMethod === 'room' ? 'expiration' : 'room';
            const btnText = document.getElementById('sort-btn-text');
            btnText.textContent = sortMethod === 'room' ? 'ê±´ë¬¼ í˜¸ìˆ˜ë³„' : 'ë§Œê¸°ì¼ ì„ë°•ìˆœ';
            renderTenants();
        }

        async function loadAndRenderTenants() {
            try {
                const res = await fetch(`/api/tenants/active-list?role=${user.role}&user_id=${user.id}`);
                if (!res.ok) throw new Error('Failed to fetch tenants');
                allTenants = await res.json();
                renderTenants();
            } catch (err) {
                console.error(err);
            }
        }

        function renderTenants() {
            const container = document.getElementById('tenant-blocks-container');
            if (!allTenants || allTenants.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:3rem; opacity:0.5;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let filtered = allTenants;
            if (hideTerminated) {
                filtered = allTenants.filter(t => t.status !== 'ì¢…ë£Œ');
            }

            const sorted = [...filtered].sort((a, b) => {
                if (sortMethod === 'expiration') {
                    const dateA = a.contract_end_date || '9999-12-31';
                    const dateB = b.contract_end_date || '9999-12-31';
                    return dateA.localeCompare(dateB);
                } else {
                    const bCompare = (a.building || '').localeCompare(b.building || '');
                    if (bCompare !== 0) return bCompare;
                    return String(a.room_number || '').localeCompare(String(b.room_number || ''), undefined, { numeric: true });
                }
            });

            container.innerHTML = `
                <div class="tenant-list">
                    ${sorted.map(t => {
                const start = t.contract_start_date || '-';
                const end = t.contract_end_date || '-';
                const building = t.building || 'ë¯¸ì§€ì •';
                const room = t.room_number || '-';
                const deposit = t.deposit ? Math.floor(t.deposit / 10000) : 0;
                const rent = t.rent ? Math.floor(t.rent / 10000) : 0;
                const mgmtFee = t.maintenance_fee ? Math.floor(t.maintenance_fee / 10000) : 0;

                return `
                            <div class="tenant-summary" style="cursor:pointer; ${t.status === 'ì¢…ë£Œ' ? 'opacity: 0.6;' : ''}" onclick="navigateToContractForm('${t.contract_id ? 'view' : 'new'}', ${t.contract_id || null}, ${JSON.stringify(t).replace(/"/g, '&quot;')})">
                                <div class="room-badge" title="${building} ${room}">
                                    <div class="b-name">${building}</div>
                                    <div class="r-num">${room}</div>
                                </div>
                                <div class="tenant-center">
                                    <div class="center-top" style="display: flex; align-items: center;">
                                        <span>${t.nickname || 'ì´ë¦„ ì—†ìŒ'}</span>
                                        ${t.status === 'ì¢…ë£Œ' ? `
                                            <span style="font-size: 0.65rem; background: rgba(239, 68, 68, 0.15); color: #f87171; padding: 1px 6px; border-radius: 4px; margin-left: 8px; border: 1px solid rgba(239, 68, 68, 0.2);">ê³„ì•½ ì¢…ë£Œë¨</span>
                                        ` : ''}
                                    </div>
                                    <div class="center-bottom">
                                        <div>${start} ~ ${end}</div>
                                        <div>${deposit.toLocaleString()} / ${rent.toLocaleString()} / ${mgmtFee.toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="tenant-actions" onclick="event.stopPropagation()">
                                    ${!t.contract_id ? `<button class="action-btn-sm btn-edit" onclick="navigateToContractForm('new', null, ${JSON.stringify(t).replace(/"/g, '&quot;')})">ê³„ì•½ ì¶”ê°€</button>` : ''}
                                    <button class="action-btn-sm btn-del" onclick="deleteTenantUser(${t.user_id}, '${t.nickname || 'ì´ë¦„ ì—†ìŒ'}')">ì‚­ì œ</button>
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }


        // Modal logic
        function navigateToContractForm(action, contractId = null, tenantData = null) {
            let url = action === 'new' ? '/contract_new.html' : `/contract_new.html?action=${action}&contract_id=${contractId}`;

            if (action === 'new' && tenantData) {
                const params = new URLSearchParams();
                params.set('action', 'new');
                if (tenantData.nickname) params.set('tenant_name', tenantData.nickname);
                if (tenantData.phone_number) params.set('tenant_phone', tenantData.phone_number);
                if (tenantData.birth_date) params.set('tenant_dob', tenantData.birth_date);
                if (tenantData.building_id) params.set('building_id', tenantData.building_id);
                if (tenantData.room_number) params.set('room_number', tenantData.room_number);
                if (tenantData.room_id) params.set('room_id', tenantData.room_id);
                url = `/contract_new.html?${params.toString()}`;
            }
            window.location.href = url;
        }

        let currentTerminateId = null;
        function openTerminateModal(contractId, name) {
            currentTerminateId = contractId;
            document.getElementById('terminate-target-name').textContent = `${name} ì„¸ì…ìì˜ í‡´ì‹¤ ì¼ìë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.`;
            document.getElementById('termination-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('terminate-modal').style.display = 'flex';
        }

        document.getElementById('confirm-terminate-btn').onclick = async () => {
            const endDate = document.getElementById('termination-date').value;
            if (!endDate) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');

            try {
                const res = await fetch(`/api/contracts/${currentTerminateId}/terminate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ end_date: endDate })
                });
                if (res.ok) {
                    alert('ê³„ì•½ ì¢…ë£Œ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal('terminate-modal');
                    loadAndRenderTenants();
                }
            } catch (err) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        async function deleteTenantUser(userId, name) {
            if (!confirm(`${name} ë‹˜ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì •ë³´(ê³„ì•½, ë©”ì‹œì§€ ë“±)ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                const res = await fetch(`/api/users/${userId}?hard=true`, { method: 'DELETE' });
                if (res.ok) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadAndRenderTenants();
                } else {
                    const data = await res.json();
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Text Extraction & Parsing logic
        let extractedText = "";
        let parsedData = null;
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        function startAIUpload() {
            document.getElementById('ai-file-input').click();
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const originalBtn = document.querySelector('[onclick="startAIUpload()"]');
            const originalText = originalBtn.textContent;
            originalBtn.disabled = true;
            originalBtn.textContent = "ì¶”ì¶œ ì¤‘...";

            try {
                if (file.type === "application/pdf") {
                    extractedText = await processPdf(file);
                } else {
                    extractedText = await processImage(file);
                }

                parsedData = parseContractText(extractedText);

                // Search for building if address exists
                if (parsedData.address) {
                    const building = await searchBuilding(parsedData.address);
                    if (building) {
                        parsedData.buildingId = building.id;
                        parsedData.buildingName = building.name;
                    }
                }

                // Automatically proceed to create contract with parsed data
                proceedWithParsedData();

            } catch (err) {
                console.error(err);
                alert('í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            } finally {
                originalBtn.disabled = false;
                originalBtn.textContent = originalText;
                event.target.value = ''; // Reset input
            }
        }

        async function processImage(file) {
            const result = await Tesseract.recognize(
                file,
                'kor+eng',
                { logger: m => console.log(m) }
            );
            return result.data.text;
        }

        async function processPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
            const pdf = await loadingTask.promise;

            let fullText = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `[Page ${i}]\n${pageText}\n\n`;
            }
            return fullText;
        }

        function parseKoreanNumber(str) {
            if (!str) return 0;
            const clean = str.replace(/[,\s]/g, '').replace(/æ•´/g, ''); // Clean punctuation
            const largeUnits = { 'ì–µ': 100000000, 'ë§Œ': 10000 };
            const smallUnits = { 'ì²œ': 1000, 'ë°±': 100, 'ì‹­': 10 };
            const digits = { 'ì¼': 1, 'ì´': 2, 'ì‚¼': 3, 'ì‚¬': 4, 'ì˜¤': 5, 'ìœ¡': 6, 'ì¹ ': 7, 'íŒ”': 8, 'êµ¬': 9 };

            function parseSmall(s) {
                if (/^\d+$/.test(s)) return parseInt(s);
                let res = 0;
                let tempDigit = 0;
                let currentNum = "";
                for (let char of s) {
                    if (digits[char]) {
                        tempDigit = digits[char];
                    } else if (smallUnits[char]) {
                        res += (tempDigit || (currentNum ? parseInt(currentNum) : 1)) * smallUnits[char];
                        tempDigit = 0;
                        currentNum = "";
                    } else if (/\d/.test(char)) {
                        currentNum += char;
                    }
                }
                if (currentNum) res += parseInt(currentNum);
                else res += tempDigit;
                return res;
            }

            let total = 0;
            let remaining = clean;
            for (const [unit, value] of Object.entries(largeUnits)) {
                const parts = remaining.split(unit);
                if (parts.length > 1) {
                    total += parseSmall(parts[0]) * value;
                    remaining = parts[1];
                }
            }
            total += parseSmall(remaining);
            return total;
        }

        function parseKoreanDate(str) {
            if (!str) return "";
            // Extract YYYY, MM, DD and normalize to YYYY-MM-DD
            // Handle "2025 ë…„ 08 ì›” 23 ì¼" or "2025ë…„ 08ì›” 23ì¼"
            const match = str.match(/(\d{4})\s*ë…„\s*(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼/);
            if (match) {
                const y = match[1];
                const m = match[2].padStart(2, '0');
                const d = match[3].padStart(2, '0');
                return `${y}-${m}-${d}`;
            }
            return "";
        }

        function parseContractText(text) {
            let processedText = text;

            // Detect if almost every character has at least one space (OCR noise)
            const totalChars = text.replace(/\s/g, '').length;
            const singleSpaceGaps = (text.match(/([ê°€-í£A-Z0-9])\s(?=[ê°€-í£A-Z0-9])/gi) || []).length;

            if (totalChars > 10 && (singleSpaceGaps / totalChars) > 0.5) {
                // Rule: Remove exactly one space from every blank sequence
                // "A B  C" (1, 2) -> "AB C" (0, 1)
                processedText = text.replace(/\s+/g, (match) => {
                    return match.substring(1);
                });
            }

            // Collapse whitespace for subsequent standard parsing logic
            const t = processedText.replace(/\s+/g, ' ');
            const data = {
                address: "",
                buildingName: "",
                roomNumber: "",
                deposit: 0,
                rent: 0,
                rentType: "postpaid",
                managementFee: 0,
                cleaningFee: 0,
                startDate: "",
                endDate: "",
                tenantName: "",
                tenantPhone: "",
                tenantDob: "",
                deExplodedText: processedText !== text ? processedText : null,
                raw: {
                    address: "",
                    room: "",
                    deposit: "",
                    rent: "",
                    mgmtFee: "",
                    cleanFee: "",
                    startDate: "",
                    endDate: "",
                    tenantName: "",
                    tenantPhone: "",
                    tenantDob: ""
                },
                nameKeywords: []
            };

            // 1. Address: between ì†Œì¬ì§€ and í† ì§€/ê±´ë¬¼ (fuzzy)
            const addrMatch = t.match(/ì†Œ\s*ì¬\s*ì§€\s*(.*?)\s*(í† \s*ì§€|ê±´\s*ë¬¼)/);
            if (addrMatch) {
                data.address = addrMatch[1].trim();
                data.raw.address = addrMatch[0];
            }

            // 2. Room: after ì„ëŒ€ë¶€ë¶„
            const roomMatch = t.match(/ì„\s*ëŒ€\s*ë¶€\s*ë¶„\s*(.*?)\s*(\d+)/);
            if (roomMatch) {
                data.roomNumber = roomMatch[2];
                data.raw.room = roomMatch[0];
            }

            // 3. Deposit: ê¸ˆ ... ì› after ë³´ì¦ê¸ˆ
            const depositRegex = /ë³´\s*ì¦\s*ê¸ˆ\s*.*?ê¸ˆ\s*(.*?)\s*ì›/;
            const depMatch = t.match(depositRegex);
            if (depMatch) {
                data.deposit = parseKoreanNumber(depMatch[1]);
                data.raw.deposit = depMatch[0];
            }

            // 4. Rent: between the LAST ì°¨ì„ before ì œ 2 ì¡°
            // Uses a negative lookahead to find the 'ì°¨ì„' closest to 'ì œ 2 ì¡°'
            const rentBlockRegex = /ì°¨\s*ì„\s*(?:(?!ì°¨\s*ì„).)*?ì œ\s*2\s*ì¡°/;
            const rentMatch = t.match(rentBlockRegex);
            if (rentMatch) {
                const block = rentMatch[0];
                data.raw.rent = block;
                const valueMatch = block.match(/ê¸ˆ\s*(.*?)\s*ì›/);
                if (valueMatch) {
                    data.rent = parseKoreanNumber(valueMatch[1]);
                    if (block.includes("ì„ ë¶ˆ")) data.rentType = "prepaid";
                    if (block.includes("í›„ë¶ˆ")) data.rentType = "postpaid";
                } else {
                    data.rent = 0;
                    data.rentType = "postpaid";
                }
            }

            // 5. Cleaning Fee: after ì²­ì†Œë¹„
            const cleanRegex = /ì²­\s*ì†Œ\s*ë¹„\s*.*?(\d[\s\dê°€-í£]*?)\s*ì›/;
            const cleanMatch = t.match(cleanRegex);
            if (cleanMatch) {
                const feeStr = cleanMatch[1].replace(/\s/g, ''); // Remove spaces
                data.cleaningFee = parseKoreanNumber(feeStr);
                data.raw.cleanFee = cleanMatch[0];
            }

            // 6. Management Fee: after ê´€ë¦¬ë¹„ëŠ”
            const mgmtRegex = /ê´€\s*ë¦¬\s*ë¹„\s*ëŠ”\s*.*?(\d[\s\dê°€-í£]*?)\s*ì›/;
            const mgmtMatch = t.match(mgmtRegex);
            if (mgmtMatch) {
                const feeStr = mgmtMatch[1].replace(/\s/g, ''); // Remove spaces
                data.managementFee = parseKoreanNumber(feeStr);
                data.raw.mgmtFee = mgmtMatch[0];
            }

            // 7. Start Date: after ì œ 2 ì¡°
            const startMatch = t.match(/ì œ\s*2\s*ì¡°\s*.*?(\d{4}\s*ë…„\s*\d{1,2}\s*ì›”\s*\d{1,2}\s*ì¼)/);
            if (startMatch) {
                data.startDate = parseKoreanDate(startMatch[1]);
                data.raw.startDate = startMatch[1];
            }

            // 8. End Date: after ì¸ë„ì¼ë¡œë¶€í„°
            const endMatch = t.match(/ì¸\s*ë„\s*ì¼\s*ë¡œ\s*ë¶€\s*í„°\s*(\d{4}\s*ë…„\s*\d{1,2}\s*ì›”\s*\d{1,2}\s*ì¼)/);
            if (endMatch) {
                data.endDate = parseKoreanDate(endMatch[1]);
                data.raw.endDate = endMatch[1];
            }

            // 9. Tenant Information: Improved robust extraction
            const tenantKeywords = ['ì„\s*ì°¨\s*ì¸', 'ì„\s*ì°¨\s*ì¸\s*\(?\s*ì„\s*\)?'];
            let sub = "";
            let foundTenantHeader = false;

            for (const kw of tenantKeywords) {
                const regex = new RegExp(kw, 'g');
                const matches = [...t.matchAll(regex)];
                if (matches.length > 0) {
                    const lastMatch = matches[matches.length - 1];
                    sub = t.substring(lastMatch.index);
                    foundTenantHeader = true;
                    break;
                }
            }

            // If no "Tenant" header found, use the last 40% of the text as fallback
            if (!foundTenantHeader) {
                sub = t.substring(Math.floor(t.length * 0.6));
            }



            // ì„±ëª… (Name) - select the LAST "ì„±ëª…" and extract until the first whitespace
            let tenantNameIdx = -1;
            const allNameMatches = [...t.matchAll(/ì„±\s*ëª…/g)];
            if (allNameMatches.length > 0) {
                const lastMatch = allNameMatches[allNameMatches.length - 1];
                const startPos = lastMatch.index + lastMatch[0].length;
                const postKeyword = t.substring(startPos, startPos + 50);

                const nameCapture = postKeyword.match(/^[ \t:ï¼š|ã…£\s]*([^ \t\n\r\s]{2,10})/);
                if (nameCapture) {
                    data.tenantName = nameCapture[1].trim();
                    data.raw.tenantName = "(ë§ˆì§€ë§‰ í‚¤ì›Œë“œ ê·¼ê±°) " + lastMatch[0] + " " + nameCapture[0];
                    tenantNameIdx = lastMatch.index;
                }
            }

            // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (Dob) - Find "ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸" keyword appearing BEFORE the tenant name
            if (tenantNameIdx !== -1) {
                const allJuminMatches = [...t.matchAll(/(?:ì£¼\s*ë¯¼\s*ë“±\s*ë¡\s*ë²ˆ\s*í˜¸|ìƒ\s*ë…„\s*ì›”\s*ì¼)/g)];
                const matchesBeforeName = allJuminMatches.filter(m => m.index < tenantNameIdx);
                if (matchesBeforeName.length > 0) {
                    const closestMatch = matchesBeforeName[matchesBeforeName.length - 1];
                    const startPos = closestMatch.index + closestMatch[0].length;
                    const postJuminSub = t.substring(startPos, startPos + 50);
                    const juminCapture = postJuminSub.match(/^[ \t:ï¼š|ã…£\s]*([0-9\s-]{6,})/);
                    if (juminCapture) {
                        const cleaned = juminCapture[1].replace(/[\s-]/g, '');
                        if (cleaned.length >= 6) {
                            const birthday = cleaned.slice(0, 6);
                            const yy = parseInt(birthday.slice(0, 2));
                            const year = yy > 30 ? '19' + birthday.slice(0, 2) : '20' + birthday.slice(0, 2);
                            data.tenantDob = `${year}-${birthday.slice(2, 4)}-${birthday.slice(4, 6)}`;
                            data.raw.tenantDob = "(ì„±ëª… ì „ í‚¤ì›Œë“œ ê²€ìƒ‰) " + closestMatch[0] + " " + juminCapture[0];
                        }
                    }
                }
            }

            // FALLBACK for DOB: If not found, check after the name
            if (!data.tenantDob && tenantNameIdx !== -1) {
                const afterName = t.substring(tenantNameIdx).substring(0, 150);
                const fallbackJuminMatch = afterName.match(/(?:ì£¼\s*ë¯¼\s*ë“±\s*ë¡\s*ë²ˆ\s*í˜¸|ìƒ\s*ë…„\s*ì›”\s*ì¼)?\s*[:ï¼š]?\s*([0-9\s-]{6,})/);
                if (fallbackJuminMatch) {
                    const cleaned = fallbackJuminMatch[1].replace(/[\s-]/g, '');
                    if (cleaned.length >= 6) {
                        const birthday = cleaned.slice(0, 6);
                        const yy = parseInt(birthday.slice(0, 2));
                        const year = yy > 30 ? '19' + birthday.slice(0, 2) : '20' + birthday.slice(0, 2);
                        data.tenantDob = `${year}-${birthday.slice(2, 4)}-${birthday.slice(4, 6)}`;
                        data.raw.tenantDob = "(ì„±ëª… í›„ì† ê²€ìƒ‰) " + fallbackJuminMatch[0];
                    }
                }
            }

            // ì „í™” (Phone) - Search for "ì „í™”" keyword appearing BEFORE the tenant name
            if (tenantNameIdx !== -1) {
                const allPhoneMatches = [...t.matchAll(/(?:ì „\s*í™”|ì—°\s*ë½\s*ì²˜)/g)];
                const matchesBeforeName = allPhoneMatches.filter(m => m.index < tenantNameIdx);
                if (matchesBeforeName.length > 0) {
                    const closestMatch = matchesBeforeName[matchesBeforeName.length - 1];
                    const startPos = closestMatch.index + closestMatch[0].length;
                    const postPhoneSub = t.substring(startPos, startPos + 50);
                    const phoneCapture = postPhoneSub.match(/^[ \t:ï¼š|ã…£\s]*([0-9\s-]{9,})/);
                    if (phoneCapture) {
                        data.tenantPhone = phoneCapture[1].replace(/\s/g, '');
                        data.raw.tenantPhone = "(ì„±ëª… ì „ í‚¤ì›Œë“œ ê²€ìƒ‰) " + closestMatch[0] + " " + phoneCapture[0];
                    }
                }
            }

            // FALLBACK: If phone is still not found, check after the name (standard block)
            if (!data.tenantPhone && tenantNameIdx !== -1) {
                const afterName = t.substring(tenantNameIdx).substring(0, 150);
                const fallbackPhoneMatch = afterName.match(/(?:ì „\s*í™”|ì—°\s*ë½\s*ì²˜)?\s*[:ï¼š]?\s*([0-9\s-]{9,})/);
                if (fallbackPhoneMatch) {
                    data.tenantPhone = fallbackPhoneMatch[1].replace(/\s/g, '');
                    data.raw.tenantPhone = "(ì„±ëª… í›„ì† ê²€ìƒ‰) " + fallbackPhoneMatch[0];
                }
            }

            // Collect all "name" keywords for debugging
            const allNameKeywords = [...t.matchAll(/ì„±\s*ëª…/g)];
            data.nameKeywords = allNameKeywords.map(m => t.substring(m.index, m.index + 20));

            return data;
        }

        async function searchBuilding(address) {
            if (!address) return null;
            try {
                // Take relevant part of address (city + street)
                const snippet = address.split(' ').slice(0, 4).join(' ');
                const res = await fetch(`/api/buildings/search-by-address?address=${encodeURIComponent(snippet)}`);
                if (!res.ok) return null;
                return await res.json();
            } catch (err) {
                return null;
            }
        }

        function openDebugModal() {
            let displayText = extractedText || "ì¶”ì¶œëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
            if (parsedData && parsedData.deExplodedText) {
                displayText += "\n\n--- [ê³µë°± ì œê±° ë° ë³µì›ëœ í…ìŠ¤íŠ¸] ---\n" + parsedData.deExplodedText;
            }
            document.getElementById('ocr-debug-content').textContent = displayText;

            const summary = document.getElementById('parsed-summary');
            if (parsedData) {
                summary.innerHTML = `
                    <div style="grid-column: span 2; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 0.5rem;">
                        <strong>ğŸ“ ì¶”ì¶œ ì£¼ì†Œ:</strong> ${parsedData.address || '-'} 
                        <div style="font-size: 0.75rem; opacity: 0.5; margin-top: 2px;">(í‚¤ì›Œë“œ: ì†Œ ì¬ ì§€ | ì›ë³¸: ${parsedData.raw.address})</div>
                    </div>
                    <div><strong>ğŸ¢ ë§¤ì¹­ ê±´ë¬¼:</strong> ${parsedData.buildingName || 'ë¯¸ë§¤ì¹­'}</div>
                    <div>
                        <strong>ğŸšª í˜¸ìˆ˜:</strong> ${parsedData.roomNumber || '-'}í˜¸
                        <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì„ëŒ€ë¶€ë¶„ | ì›ë³¸: ${parsedData.raw.room})</div>
                    </div>
                    <div>
                        <strong>ğŸ’° ë³´ì¦ê¸ˆ:</strong> ${formatCurrency(parsedData.deposit)}ì›
                        <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ë³´ì¦ê¸ˆ | ì›ë³¸: ${parsedData.raw.deposit})</div>
                    </div>
                    <div>
                        <strong>ğŸ’µ ì›”ì„¸:</strong> ${formatCurrency(parsedData.rent)}ì› (${parsedData.rentType === 'prepaid' ? 'ì„ ë¶ˆ' : 'í›„ë¶ˆ'})
                        <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì°¨ì„, ì œ2ì¡° | ì›ë³¸ ì„¹ì…˜: ${parsedData.raw.rent ? 'ì°¨ì„...ì œ2ì¡°' : '-'})</div>
                    </div>
                    <div>
                        <strong>ğŸ§¹ ì²­ì†Œë¹„:</strong> ${formatCurrency(parsedData.cleaningFee)}ì›
                        <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì²­ì†Œë¹„ | ì›ë³¸: ${parsedData.raw.cleanFee || '-'})</div>
                    </div>
                    <div>
                        <strong>âš™ï¸ ê´€ë¦¬ë¹„:</strong> ${formatCurrency(parsedData.managementFee)}ì›
                        <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ê´€ë¦¬ë¹„ëŠ” | ì›ë³¸: ${parsedData.raw.mgmtFee || '-'})</div>
                    </div>
                    <div>
                        <strong>ğŸ“… ì‹œì‘ì¼:</strong> ${parsedData.startDate || '-'}
                        <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì œ 2 ì¡° | ì›ë³¸: ${parsedData.raw.startDate || '-'})</div>
                    </div>
                    <div>
                        <strong>ğŸ ì¢…ë£Œì¼:</strong> ${parsedData.endDate || '-'}
                        <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì¸ë„ì¼ë¡œë¶€í„° | ì›ë³¸: ${parsedData.raw.endDate || '-'})</div>
                    </div>
                    <div style="grid-column: span 2; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 0.5rem;">
                        <h4 style="font-size: 0.85rem; color: var(--accent); margin-bottom: 0.5rem;">ğŸ‘¤ ì„ì°¨ì¸ ì •ë³´ (í‚¤ì›Œë“œ: ì„ ì°¨ ì¸)</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <strong>ì´ë¦„:</strong> ${parsedData.tenantName || '-'}
                                <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì„±ëª… | ì›ë³¸: ${parsedData.raw.tenantName || '-'})</div>
                            </div>
                            <div>
                                <strong>ì—°ë½ì²˜:</strong> ${formatPhone(parsedData.tenantPhone) || '-'}
                                <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì „í™” | ì›ë³¸: ${parsedData.raw.tenantPhone || '-'})</div>
                            </div>
                            <div style="grid-column: span 2;">
                                <strong>ìƒë…„ì›”ì¼:</strong> ${parsedData.tenantDob || '-'}
                                <div style="font-size: 0.75rem; opacity: 0.5;">(í‚¤ì›Œë“œ: ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ | ì›ë³¸: ${parsedData.raw.tenantDob || '-'})</div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('proceed-create-btn').style.display = 'inline-block';
            } else {
                summary.innerHTML = "ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
                document.getElementById('proceed-create-btn').style.display = 'none';
            }

            document.getElementById('debug-modal').style.display = 'flex';
        }

        function proceedWithParsedData() {
            closeModal('debug-modal');

            // Store separately to be robust
            sessionStorage.setItem('lastExtractedText', extractedText);
            sessionStorage.setItem('lastFullParsedData', JSON.stringify(parsedData));

            const params = new URLSearchParams();
            params.set('action', 'new');
            if (parsedData.buildingName) params.set('building_name', parsedData.buildingName);
            if (parsedData.roomNumber) params.set('room_number', parsedData.roomNumber);
            if (parsedData.deposit) params.set('deposit', parsedData.deposit);
            if (parsedData.rent) params.set('rent', parsedData.rent);
            if (parsedData.rentType) params.set('rent_type', parsedData.rentType);
            if (parsedData.managementFee) params.set('mgmt_fee', parsedData.managementFee);
            if (parsedData.cleaningFee) params.set('cleaning_fee', parsedData.cleaningFee);
            if (parsedData.startDate) params.set('start_date', parsedData.startDate);
            if (parsedData.endDate) params.set('end_date', parsedData.endDate);
            if (parsedData.tenantName) params.set('tenant_name', parsedData.tenantName);
            if (parsedData.tenantPhone) params.set('tenant_phone', parsedData.tenantPhone);
            if (parsedData.tenantDob) params.set('tenant_dob', parsedData.tenantDob);

            window.location.href = `/contract_new.html?${params.toString()}`;
        }
    </script>
</body>

</html>